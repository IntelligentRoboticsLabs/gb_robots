<!--
  Spawns Kobuki inside a Gazebo simulation
  -->
<launch>
  <arg name="robot_name" default="mobile_base"/>

  <arg name="posx" default="0.0"/>
  <arg name="posy" default="0.0"/>
  <arg name="posYaw" default="1.57"/>

  <param name="robot_description"
        command="$(find xacro)/xacro.py '$(find gb_robots)/definition/sim/kobuki_hexagons_asus_xtion_pro.urdf.xacro'"/>

  <node pkg="gazebo_ros" type="spawn_model" name="spawn_$(arg robot_name)"
        args="-x $(arg posx) -y $(arg posy) -Y $(arg posYaw) -unpause -urdf -param robot_description -model $(arg robot_name)" respawn="false">
  </node>

  <node pkg="robot_state_publisher" type="robot_state_publisher" name="robot_state_publisher">
    <param name="publish_frequency" type="double" value="30.0" />
  </node>


  <node pkg="laser_filters" type="scan_to_scan_filter_chain" name="laser_filter">
    <rosparam command="load" file="$(find gb_robots)/definition/sim/my_laser_config.yaml" />
  </node>

  <arg name="camera" default="camera"/>

  <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan">
    <remap from="cloud_in" to="$(arg camera)/depth/points"/>
    <remap from="scan" to="$(arg camera)/scan"/>
    <rosparam>
      target_frame: camera_link # Leave disabled to output scan in pointcloud frame
      transform_tolerance: 0.01
      min_height: 0.0
      max_height: 1.0

      angle_min: -1.5708 # -M_PI/2
      angle_max: 1.5708 # M_PI/2
      angle_increment: 0.0087 # M_PI/360.0
      scan_time: 0.3333
      range_min: 0.45
      range_max: 4.0
      use_inf: true
      inf_epsilon: 1.0

      # Concurrency level, affects number of pointclouds queued for processing and number of threads used
      # 0 : Detect number of cores
      # 1 : Single threaded
      # 2->inf : Parallelism level
      concurrency_level: 1
    </rosparam>
  </node>

  <node pkg="ira_laser_tools" name="laserscan_multi_merger" type="laserscan_multi_merger" output="screen">
   <param name="destination_frame" value="/base_laser_link"/>
   <param name="cloud_destination_topic" value="/merged_cloud"/>
   <param name="scan_destination_topic" value="/scan_multi"/>
   <param name="laserscan_topics" value ="/camera/scan /scan_filtered" /> <!-- LIST OF THE LASER SCAN TOPICS TO SUBSCRIBE -->
   <param name="angle_min" value="-3.14"/>
   <param name="angle_max" value="3.14"/>
   <param name="angle_increment" value="0.0058"/>
   <param name="scan_time" value="0.0333333"/>
   <param name="range_min" value="0.30"/>
   <param name="range_max" value="50.0"/>
  </node>

  <node pkg="nodelet" type="nodelet" name="$(arg robot_name)_nodelet_manager" args="manager"/>

</launch>
